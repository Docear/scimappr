<html>
<head>
  <script src="build/pdf.js"></script>
</head>
<body>
  <input type="file" multiple webkitdirectory id="fileURL" />

  <script>
    /*global PDFJS:false, console:false, Promise:false */

    'use strict';

    PDFJS.disableWorker = true;
    PDFJS.disableRange = true;

    // TODO: Convert this function to a promise, to handle each PDF synchronously
    var loadPDF = function (filePath, fileName) {
      PDFJS.getDocument(filePath).then(function (pdf) {
        var promises = [], promise;

        for (var i = 1; i < pdf.numPages; i++) {
          promise = pdf.getPage(i).then(function (page) {
            return page.getAnnotations();
          });
          promises.push(promise);
        }

        var ignoreList = ['Link'];

        Promise.all(promises).then(function (pages) {
          var items = [];

          pages.forEach(function(annotations) {
            annotations
              .filter(function (annotation) {
                return !ignoreList.includes(annotation.subtype)
              })
              .forEach(function(annotation) {
                items.push({ subtype: annotation.subtype, title: annotation.title, contents: annotation.contents });
              });
            });

          mindmap[fileName] = items;
        });
      });
    }

    var files,
      file,
      extension,
      input = document.getElementById("fileURL"),
      mindmap = {};

    window.mindmap = mindmap;
    input.addEventListener("change", function(e) {
      files = e.target.files;
      var len = files.length;
      var promises = [], promise;

      for (var i = 0; i < len; i++) {
        file = files[i];
        extension = file.name.split(".").pop();
        if (extension == 'pdf') {
          loadPDF(URL.createObjectURL(file), file.name);
        }
      }
    }, false);
  </script>
</body>
</html>