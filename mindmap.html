<html>
<head>
    <!-- <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 -->    <title>Scimappr</title>
	
	<!-- <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script> -->
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
	<!-- <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.7.1/themes/base/jquery-ui.css"/>-->
	<link type="text/css" rel="stylesheet" href='/scimappr/build/assets/jsmind.css'/>
	
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	
	<style>
		body {
    padding-top: 50px;
    overflow: hidden;
}
#wrapper {
    min-height: 100%;
    height: 100%;
    width: 100%;
    position: absolute;
    top: 0px;
    left: 0;
    display: inline-block;
}
<!-- #main-wrapper {
    height: 100%;
    overflow-y: auto;
    padding: 50px 0 0px 0;
	border-left: 1px solid gray;
} -->
<!-- #jsmind_container {
    position: relative;
    height: 100%;
    overflow-y: auto;
    padding: 0 15px;
	background:#f1f1f1;
}
 -->
<!-- #jsmind_container.jsmind-inner {
	position:relative;overflow:auto;width:100%;height:100%;
}
#jsmind_container.jsmind-inner {
	moz-user-select:-moz-none;
    -moz-user-select:none;
    -o-user-select:none;
    -khtml-user-select:none;
    -webkit-user-select:none;
    -ms-user-select:none;
    user-select:none;
}
 -->
#sidebar-wrapper {
    height: 100%;
    padding: 50px 0 0px 0;
    border-right: 1px solid gray;
}
#sidebar {
    position: relative;
    height: 100%;
    overflow-y: auto;
}
#sidebar .list-group-item {
        border-radius: 0;
        border-left: 0;
        border-right: 0;
        border-top: 0;
}
@media (max-width: 992px) {
    body {
        padding-top: 0px;
    }
}
@media (min-width: 992px) {
    #main-wrapper {
        float:right;
    }
}
@media (max-width: 992px) {
    #main-wrapper {
        padding-top: 0px;
    }
}
@media (max-width: 992px) {
    #sidebar-wrapper {
        position: static;
        height:auto;
        max-height: 300px;
  		border-right:0;
	}
}
 -->
 </style>
</head>
 
<body>	
<div id="header" class="navbar navbar-default navbar-fixed-top">
    <div class="navbar-header">
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".navbar-collapse">
            <i class="icon-reorder"></i>
        </button>
        <a class="navbar-brand" href="#">Scimappr</a>
    </div>
    <nav class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
             <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Files<b class="caret"></b></a>
                <ul class="dropdown-menu">
					<li><a href="javascript:open_empty()">New Mind Map</a></li>
                    <li><a href="javascript:open_json()">Open Existing</a></li>
					<li><a href="javascript:open_json()">Open File</a></li>
					<li><a href="javascript:save_freemind_file()">Save Mind Map</a></li>
					<li><a href="javascript:save_file()">Save As</a></li>
					<li><a href="javascript:myCloseConfirmation()">Close Mind Map</a></li>
					<li><a href="javascript:myExitConfirmation()">Exit</a></li>
					
                </ul>
            </li>
			<li>
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">PDF<b class="caret"></b></a>
				<ul class="dropdown-menu">
					<li><a href="javascript:mainRefreshPdf()">Refresh PDFs</a></li>
					<li><a href="javascript:prompt_info('under construction')">Add PDF</a></li>
					
				</ul>
            </li>
			<li>
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Nodes<b class="caret"></b></a>
				<ul class="dropdown-menu">
					<li><a href="javascript:add_node()">New Node</a></li>
					<li><a href="javascript:add_node()">New Image Node</a></li>
					
				</ul>
            </li>
            <li>
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project<b class="caret"></b></a>
				<ul class="dropdown-menu">
					<li><a href="javascript:prompt_info('under construction')">New Project</a></li>
					<li><a href="javascript:prompt_info('under construction')">Open Location</a></li>
					
				</ul>
            </li>
        </ul>
        <ul class="nav navbar-nav pull-right">
            <li class="dropdown">
                <a href="#" id="nbAcctDD" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-user"></i>Username<i class="icon-sort-down"></i></a>
                <ul class="dropdown-menu pull-right">
                    <li><a href="#">Log Out</a></li>
                </ul>
            </li>
        </ul>
    </nav>
</div>
<div id="wrapper">
	<div id="sidebar-wrapper" class="col-md-2">
			<ul class="list-group">
				<!-- <li id='list1' class="list-group-item drag">Cras justo odio</li>
				<li id='list2' class="list-group-item drag">Dapibus ac facilisis in</li>
				<li id='list3' class="list-group-item drag">Morbi leo risus</li>
				<li id='list4' class="list-group-item drag">Porta ac consectetur ac</li>
				<li id='list5' class="list-group-item drag">Vestibulum at eros</li> -->
				
			</ul>
			
    </div>
    <div id="main-wrapper" class="col-md-10 pull-right">
        <div id="jsmind_container" class="panel-resizable drop"> </div>
		<div style="display:none">
			<input class="file" type="file" id="image-chooser" accept="image/*"/>
		</div>
    </div>  
</div>
<div id="push"></div>
	<script type="text/javascript" src='/scimappr/build/assets/jsmind.js'></script>
	<script type="text/javascript" src='/scimappr/build/assets/jsmind.draggable.js'></script>
	<script type="text/javascript" src='/scimappr/build/assets/jsmind.screenshot.js'></script>
	<script type="text/javascript" src='/scimappr/build/assets/mindmap.js'></script>
	<script type="text/javascript" src='/scimappr/build/assets/md5-min.js'></script>
	<!-- Latest compiled and minified JavaScript -->
	<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="/scimappr/build/assets/pdf.js"></script>
	<script>
	
	"use strict";
	
	(function ($) {
	
	// ============================================================================================= //
	// JQuery Section
	// ============================================================================================= //
	
		// Main Caller
		window.onload = drag_drop();
	
		function drag_drop() {
			var counter = 0;
			var objName = "";
			var fileName = "/scimappr/doc/example.pdf"
			var options = {
				container:'jsmind_container',
				editable:true,
				theme:'orange'
			};
			
			
			$( ".drag" ).draggable({
				helper: 'clone',
				containment:'frame',
				opacity:'0.5',
				revert: 'invalid',
				appendTo: 'body',
				stop: function (ev, ui) {	
				var pos = $(ui.helper).offset();
				objName = "#clonediv" + counter
				$(objName).css({
					"left": pos.left,
					"top": pos.top
				});
				$(objName).removeClass("drag");
			}
			});
			
			
			$(".drop").droppable({
				drop: function (ev, ui) {
						var selected_node = _jm.get_selected_node(); // select node when mouseover
						if(!selected_node){
							prompt_info('please select a node first.');
							return;
						}
						var nodeid = ui.helper.prevObject.context.id;
						var topic = ui.helper.prevObject.context.innerHTML;
						var node = _jm.add_node(selected_node, nodeid, topic);
					}
			});	
		}
		
	
	})(jQuery)
	
	// ============================================================================================= //
	// Function Section
	// ============================================================================================= //
	
	//'use strict';
	PDFJS.workerSrc = '/scimappr/build/assets/pdf.worker.js';
    PDFJS.disableWorker = true;
    PDFJS.disableRange = true;
	
	var dir = "/scimappr/doc/";
	var listFile = [];
	var files,
      file,
      extension,
      input = document.getElementById("fileURL"),
      mindmap = {};


	// When PDF is refreshed
	var mainRefreshPdf = function() {
		populateDir().then(function(v){
			listFile = v;
		Promise.all(listFile).then(function(v) {
				for(var k in listFile) {
				loadPDF(listFile[k], listFile[k].replace("http://", "").replace("localhost/", ""))
				}
			});
		});
	}
	
	
	// Keep the records of PDF File in a folder
	var populateDir = function() {
		return new Promise(function(resolve, reject) {
			var xhr = $.ajax({
            //This will retrieve the contents of the folder if the folder is configured as 'browsable'
			type:"GET",
            url: dir,
            success: function (data) {
			
				//console.log(xhr);
				
               //List all pdfs file names in the page
               $(data).find("a:contains(" + ".pdf" + ")").each(function (e) {
					var filename = this.href.replace("http://", "").replace("localhost/", "").replace("scimappr/","doc/");
					getLastMod("/scimappr/" + filename, function(v) {
						console.log(v);
					});
					listFile.push(filename);
					resolve (listFile);
				});
            }
            });
		});
	}
	
	// get the annotations in a PDF File	
	var loadPDF = function (filePath, fileName) {
      PDFJS.getDocument(filePath).then(function (pdf) {
        var promises = [], promise;
        for (var i = 1; i < pdf.numPages; i++) {
          promise = pdf.getPage(i).then(function (page) {
            return page.getAnnotations();
          });
          promises.push(promise);
        }
        var ignoreList = ['Link'];
        Promise.all(promises).then(function (pages) {
          var items = [];
          pages.forEach(function(annotations) {
            annotations
              .filter(function (annotation) {
                return !ignoreList.includes(annotation.subtype)
              })
              .forEach(function(annotation) {
			  if((annotation.contents != "") && (annotation.subtype == "Popup")) {
			  items.push({
                  id: getHashFunction(fileName + " " + annotation.contents),
                  subtype: annotation.subtype,
                  title: annotation.title,
                  topic: annotation.contents
                });
			  }

              });
            });
          sendData({ fileName: fileName, data: items });
        })
      });
    }

	var sendData = function (data) {

	  $("#loading-data").remove();
	  $("#drag").remove();
	  var file_title = "<li style='cursor: no-drop; background-color: #ccc;padding: 10px 18px'>" + data.fileName + "</li>";
	  $(file_title).appendTo(".list-group");
	  for(var m = 0; m < data.data.length; m++) {


	  // Make JSON File
		var json_listmaker = {
				data: {
					id: data.data[m].id, topic: data.data[m].topic
				}
			}

		var json_result = JSON.stringify(json_listmaker);

		// Parse JSON File back

		var objekt = JSON.parse(json_result);

		var html_dynamic = "<li id=" + objekt.data.id +  ">" + objekt.data.topic + "</li>";

		var counter = 0;
		var objName = "";

		$(html_dynamic).appendTo(".list-group").draggable({
				helper: 'clone',
				containment:'frame',
				opacity:'0.5',
				revert: 'invalid',
				appendTo: 'body',
				stop: function (ev, ui) {
				var pos = $(ui.helper).offset();
				objName = "#clonediv"
				$(objName).css({
					"left": pos.left,
					"top": pos.top
				});
				$(objName).removeClass("drag");
			}
			});

		document.getElementById(objekt.data.id).className += "drag list-group-item";
		document.getElementById(objekt.data.id).style += "z-index: 5";

		// Hide nodes that are already in the mindmap
	  	if (_jm.mind.nodes[objekt.data.id]) {
	  		$('#'+objekt.data.id).hide();
	  	}
	  }

    }

	// generate random string
	var getRandomString = function (num) {
      num = num || 6;
      return Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, num);
    };

	// generate Hash function for Id
	var getHashFunction = function (input) {
		var hash = hex_md5("string");
		var hmac = hex_hmac_md5("19", input);
		return hmac;
	}

	// generate last modified date & time
	var getLastMod = function(url, cb) {
		var req = new XMLHttpRequest();
		req.open("GET", url);
		req.send(null);
		req.addEventListener("load", function() {
			cb(req.getResponseHeader("Last-Modified"));
		}, false);
	}
	
	var setDraggable = function(input) {
		var counter = 0;
		var objName = "";
		input.draggable({
				helper: 'clone',
				containment:'frame',
				opacity:'0.5',
				revert: 'invalid',
				appendTo: 'body',
				stop: function (ev, ui) {	
				var pos = $(ui.helper).offset();
				objName = "#clonediv"
				$(objName).css({
					"left": pos.left,
					"top": pos.top
				});
				$(objName).removeClass("drag");
			}
		});

		return input;

	}

	// Update the annotation panel on each MindMap event
	_jm.add_event_listener(function () {
		var mindmap = _jm.get_data();
		var nodes = $('.list-group-item').get();
		nodes.forEach(function (node) {
			if (_jm.mind.nodes[node.id]) {
				$('#'+node.id).hide();
			} else {
				$('#'+node.id).show();
			}
		});

		// Update localStorage with the current mindmap data on every update
		window.localStorage.setItem('json_data', JSON.stringify(_jm.get_data()));
	});


	function myCloseConfirmation() {
		 if(confirm('are you sure to close?'))
           return true;
      else
           return false;
	}

	function myExitConfirmation() {
		 if(confirm('are you sure to exit?'))
           return true;
      else
           return false;
	}

	</script>
</body>
</html>
